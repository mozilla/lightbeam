# File Formats in Collusion

Collusion has an existing file format for saved files, but is migrating to a new format that captures multiple site visits and changes over time better. Both formats will be documented, along with heuristics for determining which is which when opening a saved file, and rules for converting from the old format to the new one.

## Format 0

This format takes the following structure:

A root object whose keys are third-party URLs (potential trackers). These URLs are reduced to the simple domain, with all protocol, subdomain, query, path, and fragment components stripped off. Each key's value is an object containing the keys "referrers" and (optionally) visited. If a site has been the target of a user's browsing (i.e., the user intentionally loaded the site), it should be marked "visited": true. Lack of a "visited" key is the same as "visited": false. The value of the "referrers" key is an object whose keys are the referrers which included this potential tracker in their page(s). The "referrer" keys are also domain names, URLs stripped of all other information.

Each referrer value is an object containing the keys "timestamp", "datatypes", (optionally) "cookie" and (optionally) "noncoookie". Some save files also include the key "uploaded" which was left in by mistake from an earlier experiment and is not used. 

The "timestamp" value is an integer representation of time, in milliseconds since Collusion was last started or cleared (yes, this makes the timestamp only useful for basic ordering, and when data is reloaded from a save file or browser restart, we even lose ordering). 

The "datatypes" value is a list of zero or more datatypes, which may contain null values. The list is the collection of unique values which have been reported by the site in the "Content-Type" response header, i.e., a list of all the types of content that have been loaded *by that referrer* from the potential tracker. 

The "cookie" value is a boolean flag set if any request by that referrer to the potential tracker contained a cookie, with an absent "cookie" key being the same as a "cookie" value of false. 

The "noncookie" value is a boolean flag set if any request by that referrer to the potential tracker does *not* contain a cookie, with an absent "noncookie" key being the same as a "cookie" value of false. It is possible for a referrer to have both "cookie" and "noncookie" flags set if different requests to the potential tracker had different headers (some with cookies, some without).

Example:

``` json
{
    "google.com": {
        "referrers": {
            "google.ca": {
                "timestamp": 35974,
                "datatypes": [
                    "image/jpeg",
                    "image/png",
                    "image/jpeg;charset=UTF-8"
                ],
                "uploaded": false,
                "cookie": true
            }
        }
    }
}
```

## Format 1.0

This format has the following structure:

A root object whose keys are "format", "version", (optionally) "token", "connections", and (optionally) "lastSync". 

The "format" value is the string "Collusion Save File" and is for documentation and identification of JSON files which are Collusion-specific. 

The "version" value is the string "1.0" and identifies the specifc format documented here. A missing "version" key is the same as a "version" value of "0" and should be parsed and interpreted as specified for Format 0 above. 

The "token" value is a Type-4 UUID (randomly generated) which can be used by a server to group updates and check for overlap or duplicate calls. This is generated by the client the first time data is shared.

The "token" value is only shared between client and server and is not exposed by the server to queries, not associated with an IP address, or otherwise traceable back to a specific client. If a client has not opted into sharing Collusion data, it will not have a "token" key. 

The optional "lastSync" value is likewise only present if the client has opted into sharing Collusion data, and records the timestamp of the last item in the "connections" value which was shared. This value does not need to, and should not be, correlated with the time the shared data was uploaded, to avoid being able to connect data back to the client that shared it. The "lastSync" value is kept by the client only, and is not sent to the server when data is shared.

The "connections" value makes up the bulk of the file. It is an array of connection array objects, where each connection is represented as an array of values in the following order: [source, target, timestamp, contentType, cookies, sourceVisited, protocol, sourcePathDepth, sourceQueryDepth]. Because we will be storing a lot more information over time than the older format, we do not store keys repetitively with each connection, but effectively a 9-tuple corresponding closely to a database row.

The source value is a URL containing domain and subdomain information for the requested site, but stripped of protocol, path, query, and fragment. Note, this is a change from the earlier format which also stripped off subdomain information that is now retained.

The target value is a URL containing domain and subdomain information for a resource loaded from a third-party site, [QUESTION: should we include connections which differ only by subdomain as third-party content?], and like the source the target is stripped of protocol, path, query, and fragment. Likewise, this is a change from the earlier format which also stripped off subdomain information which is now retained.

Timestamp is an integer number of milliseconds since the Unix epoch (January 1, 1970) as normally used for Javascript Date objects. The granularity of the timestamp is intentionally reduced when this data is shared, by rounding timestamps down to the [UNIT, 10 minutes? 1 hour?] to prevent trackers from comparing our data with theirs to re-associate our data with individual users. Note, this is a change from the earlier data format which only stored timestamps relative to the time Collusion was started, and couldn't be used to restore actual session dates or times.

The contentType value is the string reported by the target in the Content-Type header, although we MAY also compare with the actual type returned to improve the accuracy of this value. If there is no Content-Type header we WILL attempt to determine the type of the content. If all attempts fail, a default content type [FIXME: empty string or mime-type?] will be used, but the value WILL NOT be null.

The cookies value is an integer representing the number Set-Cookie headers returned by the target. [QUESTION: Should this simply be a boolean? Are there advantages to storing the count? Are there security/privacy implications?]. A value of 0 indicates that no cookies were returned with the target.

The sourceVisited value is either true or false, indicating whether or not the source was loaded by the user in a page or tab. While it is expected that this value will generally be true, it may be false for sources in iframes. [QUESTION: Is this value worth tracking? Are there other contexts where the referrer of a target might not be in the user history or otherwise loaded in a tab or window?]

The protocol will generally be either "http" or "https", representing what type of connection the target is loaded with [QUESTION: What other possibilities are there for third-party content? Can this be a simple flag?]

The sourcePathDepth is a metric of how many path elements there were in the source URL before it was sanitized. The URL http://example.com/ has a depth of 0, while the URL http://example.com/blog/post/2012/12/21 has a depth of 5.

The sourceQueryDepth is a metric of how many items there were in the query string. This is not a test of unique keys, just simple breaking after the "?" and splitting on "&" and ";". Again, http://example.com/ has a depth of 0, as does http://example.com/?, while http://example.com/?captain=kirk&ship=enterprise, http://example.com/?captain=kirk&captain=picard, and http://example.com/?captain=kirk;ship=enterprise all have a depth of 2.

## Converting from Format 0 to Format 1.0

Because so much information is thrown away in Format 0 (subdomains, absolute timestamps, protocol, multiple connections, protocol, path and query depths), there is not a lot that can be restored. At best we could create a starting point for moving forward, listing a single connection for each referrer in each potential tracker, with timestamps synthesized from, say, the previous day's Date() + the Fomat 0 "timestamp". Given that the point of Format 1.0 is to track data over time, and the Format 0 does not have much in the way of time data, I'm not actually sure how much value there is in this.

